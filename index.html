<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>我的收藏与工具 · Plus</title>
<meta name="theme-color" content="#0ea5e9">
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --fg:#0f172a; --muted:#6b7280; --border:#e5e7eb; --brand:#0ea5e9;
    --shadow:0 8px 20px rgba(2,8,23,.06);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --fg:#e5e7eb; --muted:#9aa4b2; --border:#1f2937; --brand:#22d3ee;
    --shadow:0 8px 18px rgba(2,8,23,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 500px at 0 -100px, rgba(14,165,233,.12), transparent 60%), var(--bg);
    color:var(--fg); font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Apple Color Emoji,Segoe UI Emoji}
  a{color:inherit}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  header{position:sticky;top:0;z-index:30;background:rgba(255,255,255,.55);
    backdrop-filter:saturate(1.2) blur(10px); border-bottom:1px solid var(--border)}
  [data-theme="dark"] header{background:rgba(17,24,39,.5)}
  h1{margin:0;font-size:18px;display:flex;align-items:center;gap:10px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .grow{flex:1}
  input[type="text"], input[type="url"], select, textarea{
    width:100%;border:1px solid var(--border);background:var(--card);color:var(--fg);
    border-radius:12px;padding:10px 12px;outline:0
  }
  .btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#002b36}
  .btn.ghost{background:transparent}
  .chip{padding:6px 12px;border:1px solid var(--border);border-radius:999px;background:var(--card);cursor:pointer;font-size:12px}
  .chip.active{background:var(--fg);color:var(--bg);border-color:var(--fg)}
  .toolbar{display:flex;gap:8px;overflow:auto;padding:8px 0 12px 0}
  main{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media(max-width:960px){main{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow)}
  .card .hd{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:end}
  .card .bd{padding:12px 14px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  @media(max-width:1200px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}}
  .link{border:1px solid var(--border);border-radius:16px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.02));display:flex;gap:10px;align-items:flex-start;transition:.15s transform, .15s box-shadow}
  .link:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(2,8,23,.08)}
  .icon{width:34px;height:34px;border-radius:10px;background:radial-gradient(circle at 30% 20%, rgba(14,165,233,.5), transparent 60%), #eef2ff; display:grid;place-items:center; overflow:hidden}
  [data-theme="dark"] .icon{background:#111827}
  .icon img{width:100%;height:100%;object-fit:cover}
  .ttl{font-weight:650;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .host{font-size:12px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:10px;border:1px solid var(--border);border-radius:999px;padding:2px 6px}
  .actions{margin-left:auto;display:flex;gap:6px}
  .muted{color:var(--muted)}
  .kbd{border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:.5px 6px;font-size:11px;background:var(--card)}
  footer{color:var(--muted);text-align:center;padding:18px 0}
  .tip{font-size:12px;color:var(--muted)}
  /* modal */
  .layer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;padding:16px}
  .dialog{width:min(560px,100%);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .hidden{display:none !important}
  /* toast */
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;background:var(--fg);color:var(--bg);opacity:0;transition:.3s;pointer-events:none}
  #toast.show{opacity:1;transform:translate(-50%,-6px)}
  /* drag mark */
  .dragging{opacity:.6}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>🔧 我的收藏与工具 · <span style="font-weight:400">Plus</span></h1>
    <input id="search" class="grow" type="text" placeholder="搜索 标题 / 链接 / 标签（按 / 聚焦）" />
    <button id="addBtn" class="btn primary">+ 添加</button>
    <button id="starFilter" class="btn" title="仅看收藏（S）">⭐</button>
    <button id="themeBtn" class="btn" title="切换明暗（T）">🌓</button>
    <div class="row">
      <button id="exportBtn" class="btn">导出</button>
      <label class="chip">导入<input id="importFile" type="file" accept="application/json" class="hidden"></label>
    </div>
  </div>
  <div class="wrap toolbar" id="catBar"></div>
</header>

<main class="wrap">
  <section class="card">
    <div class="hd">
      <div>链接库 <span class="muted" id="countInfo"></span></div>
      <div class="tip">拖动卡片可在分类内排序 · 快捷键：<span class="kbd">/</span>搜索 <span class="kbd">N</span>新建 <span class="kbd">S</span>收藏筛选 <span class="kbd">T</span>明暗</div>
    </div>
    <div class="bd">
      <div class="grid" id="linksGrid"></div>
    </div>
  </section>

  <aside class="card">
    <div class="hd"><div>快速添加 & 小工具</div></div>
    <div class="bd" style="display:grid;gap:12px">
      <div>
        <div class="tip" style="margin-bottom:6px">粘贴网址自动生成标题（取域名），可选写标签</div>
        <div class="row">
          <input id="quickUrl" type="url" placeholder="https://..." />
          <input id="quickTags" type="text" placeholder="标签 逗号分隔（可选）" style="max-width:200px" />
          <select id="quickCat" style="max-width:180px"></select>
          <button id="quickAdd" class="btn primary">添加</button>
        </div>
      </div>
      <hr/>
      <div>
        <div class="tip">JSON 格式化</div>
        <textarea id="jsonBox" rows="5" placeholder='粘贴 JSON, 点击格式化'></textarea>
        <div class="row"><button class="btn" id="jsonFmt">格式化</button><button class="btn ghost" id="jsonMin">压缩</button></div>
      </div>
    </div>
  </aside>
</main>

<footer class="wrap">数据保存在你的浏览器（localStorage）。清理浏览器数据会清空收藏。</footer>

<!-- 弹窗 -->
<div id="modal" class="layer hidden">
  <div class="dialog">
    <div style="padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <b id="modalTitle">添加链接</b>
      <button onclick="closeModal()" class="btn ghost">✕</button>
    </div>
    <div style="padding:12px 14px;display:grid;gap:8px">
      <label>分类
        <select id="formCat"></select>
      </label>
      <label>标题
        <input id="formTitle" type="text" placeholder="例如：Google Scholar" />
      </label>
      <label>URL
        <input id="formUrl" type="url" placeholder="https://..." />
      </label>
      <label>标签（用逗号分隔）
        <input id="formTags" type="text" placeholder="paper, ai, tool" />
      </label>
      <label><input id="formStar" type="checkbox" /> 设为收藏</label>
      <div class="row" style="justify-content:end">
        <button class="btn ghost" onclick="closeModal()">取消</button>
        <button class="btn primary" id="saveBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<div id="toast">已保存</div>

<script>
// ====== 数据存取 ======
const STORAGE_KEY = "my_links_hub_plus_v1";
const THEME_KEY = "my_links_theme";
const DEFAULT_DATA = [
  {id:"dev", name:"开发 / Developer", links:[
    {id:uid(), title:"GitHub", url:"https://github.com", tags:["code","repo"], starred:true},
    {id:uid(), title:"Stack Overflow", url:"https://stackoverflow.com", tags:["qa"]},
    {id:uid(), title:"MDN Docs", url:"https://developer.mozilla.org", tags:["docs"]},
  ]},
  {id:"research", name:"研究 / Research", links:[
    {id:uid(), title:"Google Scholar", url:"https://scholar.google.com", tags:["paper"], starred:true},
    {id:uid(), title:"arXiv", url:"https://arxiv.org", tags:["preprint"]},
  ]},
  {id:"life", name:"生活 / Life", links:[
    {id:uid(), title:"Bilibili", url:"https://www.bilibili.com", tags:["video"]},
  ]},
];
let state = load() || DEFAULT_DATA;
function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||""); }catch(e){ return null; } }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
// theme
const theme = localStorage.getItem(THEME_KEY) || "light";
document.documentElement.setAttribute("data-theme", theme);

// ====== UI 状态 ======
let activeCat = "all";
let search = "";
let starOnly = false;

// ====== DOM ======
const catBar = document.getElementById("catBar");
const grid = document.getElementById("linksGrid");
const countInfo = document.getElementById("countInfo");
const searchBox = document.getElementById("search");
const addBtn = document.getElementById("addBtn");
const starBtn = document.getElementById("starFilter");
const themeBtn = document.getElementById("themeBtn");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");
const toast = document.getElementById("toast");
// quick add
const qUrl = document.getElementById("quickUrl");
const qTags = document.getElementById("quickTags");
const qCat = document.getElementById("quickCat");
const qAdd = document.getElementById("quickAdd");
// json tool
const jsonBox = document.getElementById("jsonBox");
document.getElementById("jsonFmt").onclick = () => { try{ jsonBox.value = JSON.stringify(JSON.parse(jsonBox.value), null, 2);} catch(e){ alert("不是有效 JSON"); } };
document.getElementById("jsonMin").onclick = () => { try{ jsonBox.value = JSON.stringify(JSON.parse(jsonBox.value)); } catch(e){ alert("不是有效 JSON"); } };

// modal form
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const formCat = document.getElementById("formCat");
const formTitle = document.getElementById("formTitle");
const formUrl = document.getElementById("formUrl");
const formTags = document.getElementById("formTags");
const formStar = document.getElementById("formStar");
const saveBtn = document.getElementById("saveBtn");
let editing = null; // {catId, linkId}

// ====== 初始化 ======
renderCats();
renderLinks();
fillQuickCats();
searchBox.addEventListener("input", e => { search = e.target.value.trim().toLowerCase(); renderLinks(); });
addBtn.addEventListener("click", () => openAddModal());
starBtn.addEventListener("click", () => { starOnly = !starOnly; starBtn.classList.toggle("primary", starOnly); renderLinks(); });
themeBtn.addEventListener("click", toggleTheme);
exportBtn.addEventListener("click", onExport);
importFile.addEventListener("change", onImport);
qAdd.addEventListener("click", quickAdd);

// 快捷键
document.addEventListener("keydown", (e) => {
  if (e.key === "/"){ e.preventDefault(); searchBox.focus(); }
  if (e.key.toLowerCase() === "n"){ openAddModal(); }
  if (e.key.toLowerCase() === "s"){ starBtn.click(); }
  if (e.key.toLowerCase() === "t"){ toggleTheme(); }
});

// ====== 渲染 ======
function renderCats(){
  const cats = [{id:"all", name:"全部"}, ...state.map(c => ({id:c.id, name:c.name}))];
  catBar.innerHTML = "";
  cats.forEach(c => {
    const btn = document.createElement("button");
    btn.className = "chip" + (activeCat===c.id ? " active" : "");
    btn.textContent = c.name;
    btn.onclick = () => { activeCat = c.id; renderLinks(); renderCats(); };
    catBar.appendChild(btn);
  });
  // 新建分类
  const addCat = document.createElement("button");
  addCat.className = "chip";
  addCat.textContent = "新建分类";
  addCat.onclick = () => {
    const name = prompt("分类名称（如：学习、工作…）");
    if(!name) return;
    const id = name.toLowerCase().replace(/\s+/g,"-") + "-" + Date.now().toString().slice(-4);
    state = [{id, name, links:[]}, ...state];
    save(); renderCats(); fillQuickCats(); toastMsg("已创建分类");
  };
  catBar.appendChild(addCat);
}

function renderLinks(){
  const allLinks = state.flatMap(c => c.links.map(l => ({...l, catId:c.id, catName:c.name})));
  const filtered = allLinks.filter(l => {
    const inCat = activeCat==="all" || l.catId===activeCat;
    if(!inCat) return false;
    if(starOnly && !l.starred) return false;
    if(!search) return true;
    return (l.title?.toLowerCase().includes(search) ||
            l.url?.toLowerCase().includes(search) ||
            (l.tags||[]).some(t => t.toLowerCase().includes(search)));
  });
  countInfo.textContent = `（共 ${filtered.length} 条）`;
  grid.innerHTML = "";
  filtered.forEach(l => grid.appendChild(linkNode(l)));
  // 允许拖拽：仅在某一个分类激活且非“全部”时
  if(activeCat !== "all"){
    enableDragDrop();
  }
}

function linkNode(l){
  const el = document.createElement("div");
  el.className = "link";
  el.setAttribute("data-id", l.id);
  el.setAttribute("draggable", true);
  const host = safeHost(l.url);
  const ico = host ? `https://www.google.com/s2/favicons?domain=${encodeURIComponent(host)}&sz=64` : "";
  el.innerHTML = `
    <div class="icon">${ico ? `<img src="${ico}" alt="">` : "🔗"}</div>
    <div style="min-width:0;flex:1">
      <div class="ttl" title="${esc(l.title||"")}">${esc(l.title||"")}</div>
      <div class="host" title="${esc(host)}">${esc(host)}</div>
      ${(l.tags?.length?`<div class="tags">${l.tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join("")}</div>`:"")}
    </div>
    <div class="actions">
      <button class="btn" title="收藏/取消收藏" onclick="toggleStar('${l.catId}','${l.id}')">${l.starred?"⭐":"☆"}</button>
      <a href="${escAttr(l.url||"#")}" target="_blank"><button class="btn" title="打开">↗</button></a>
      <button class="btn" title="编辑" onclick="openEditModal('${l.catId}','${l.id}')">✎</button>
      <button class="btn" title="删除" onclick="delLink('${l.catId}','${l.id}')">🗑</button>
    </div>`;
  return el;
}

function enableDragDrop(){
  const cards = grid.querySelectorAll(".link");
  cards.forEach(card => {
    card.addEventListener("dragstart", (e) => { card.classList.add("dragging"); e.dataTransfer.setData("text/plain", card.dataset.id); });
    card.addEventListener("dragend", () => card.classList.remove("dragging"));
  });
  grid.addEventListener("dragover", (e) => { e.preventDefault();
    const dragging = grid.querySelector(".dragging");
    const afterEl = getDragAfterElement(grid, e.clientY);
    if(dragging){
      if(afterEl == null) grid.appendChild(dragging);
      else grid.insertBefore(dragging, afterEl);
    }
  });
  grid.addEventListener("drop", () => {
    // 读取新的顺序写回 state（仅当前分类）
    const ids = Array.from(grid.querySelectorAll(".link")).map(el => el.dataset.id);
    const idx = state.findIndex(c=>c.id===activeCat);
    if(idx>=0){
      const map = new Map(state[idx].links.map(l=>[l.id,l]));
      state[idx].links = ids.map(id => map.get(id)).filter(Boolean);
      save(); toastMsg("已更新排序");
    }
  });
}
function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll(".link:not(.dragging)")];
  return els.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// ====== 交互：添加/编辑/删除/收藏 ======
function openAddModal(){
  editing = null;
  modalTitle.textContent = "添加链接";
  fillCatOptions();
  formTitle.value = ""; formUrl.value = ""; formTags.value = ""; formStar.checked = false;
  saveBtn.onclick = () => {
    const c = formCat.value, t=formTitle.value.trim(), u=formUrl.value.trim();
    if(!c || !t || !u) return alert("请填写完整：分类、标题、URL");
    addLink(c, {title:t, url:u, tags:splitTags(formTags.value), starred:formStar.checked});
    closeModal(); toastMsg("已添加");
  };
  openModal();
}

function openEditModal(catId, linkId){
  editing = {catId, linkId};
  modalTitle.textContent = "编辑链接";
  fillCatOptions(catId);
  const link = state.find(c=>c.id===catId).links.find(x=>x.id===linkId);
  formTitle.value = link.title||""; formUrl.value = link.url||""; formTags.value = (link.tags||[]).join(", "); formStar.checked = !!link.starred;
  saveBtn.onclick = () => {
    updateLink(catId, linkId, {title:formTitle.value.trim(), url:formUrl.value.trim(), tags:splitTags(formTags.value), starred:formStar.checked});
    closeModal(); toastMsg("已保存");
  };
  openModal();
}
function openModal(){ modal.classList.remove("hidden"); }
function closeModal(){ modal.classList.add("hidden"); }

function fillCatOptions(selectedId){
  formCat.innerHTML = state.map(c=>`<option value="${c.id}" ${selectedId===c.id?"selected":""}>${esc(c.name)}</option>`).join("");
}
function fillQuickCats(){
  qCat.innerHTML = state.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");
}

function addLink(catId, payload){
  const idx = state.findIndex(c=>c.id===catId);
  if(idx<0) return;
  state[idx] = {...state[idx], links:[{id:uid(), ...payload}, ...state[idx].links]};
  save(); renderLinks();
}
function updateLink(catId, linkId, payload){
  state = state.map(c => c.id===catId ? {...c, links: c.links.map(l => l.id===linkId ? {...l, ...payload} : l)} : c);
  save(); renderLinks();
}
function delLink(catId, linkId){
  if(!confirm("确定要删除这条链接吗？")) return;
  state = state.map(c => c.id===catId ? {...c, links: c.links.filter(l=>l.id!==linkId)} : c);
  save(); renderLinks(); toastMsg("已删除");
}
function toggleStar(catId, linkId){
  state = state.map(c => c.id===catId ? {...c, links: c.links.map(l => l.id===linkId ? {...l, starred:!l.starred} : l)} : c);
  save(); renderLinks();
}

// ====== 快速添加 ======
function quickAdd(){
  const url = qUrl.value.trim();
  if(!url) return alert("请填入网址");
  const cat = qCat.value;
  const titleGuess = safeHost(url);
  addLink(cat, {title: titleGuess || url, url, tags: splitTags(qTags.value), starred: false});
  qUrl.value = ""; qTags.value = "";
  toastMsg("已添加");
}

// ====== 备份/恢复 ======
function onExport(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "my-links-backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
async function onImport(e){
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    if(!Array.isArray(data)) throw new Error("格式不正确");
    state = data; save(); renderCats(); renderLinks(); fillQuickCats();
    toastMsg("导入成功");
  }catch(err){ alert("导入失败：" + err.message); }
  e.target.value = "";
}

// ====== 主题与工具 ======
function toggleTheme(){
  const cur = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", cur);
  localStorage.setItem(THEME_KEY, cur);
}
function toastMsg(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1400); }

// ====== 小工具函数 ======
function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36).slice(-4); }
function splitTags(s){ return s.split(/[，,]/).map(t=>t.trim()).filter(Boolean); }
function safeHost(url){ try{ return new URL(url).hostname.replace(/^www\./,""); }catch(e){ return ""; } }
function esc(s){ return (s||"").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }
function escAttr(s){ return esc(s).replace(/\"/g,"&quot;"); }
// 键盘：Esc 关闭弹窗
document.addEventListener("keydown", e => { if(e.key==="Escape" && !modal.classList.contains("hidden")) closeModal(); });
</script>
</body>
</html>
